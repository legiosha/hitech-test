<?php

namespace App\Controllers;

include(__ROOT__.'/Controller.php');
include(__ROOT__.'/Models/Phone.php');
include(__ROOT__.'/Models/Validations.php');

use App\Controller;
use App\Models\Phone;
use App\Models\Validations;

class IndexController extends Controller
{
    public function index()
    {
        $this->render('index');
    }

    public function check(mixed $args)
    {
        $phone = new Phone($args);
        $fio = $phone->fio();
        $number = $phone->number();
        $code = $phone->code();
        if ($phone->fio() !== "" && $code !== "" && $number !== "") {
            if ($this->validate($fio, Validations::FIO) && $this->validate($code.$number, Validations::PHONE)) {
            $country = $this->getCountryByPhoneCode($code);
                echo json_encode([
                    "status" => "OK",
                    "description" => "Номер верный",
                    "country" => $country
                ]);
            } else {
                echo json_encode([
                    "status" => "ERROR",
                    "description" => "Проверка не пройдена"
                ]);
            }
        } else {
            echo json_encode([
                "status" => "ERROR",
                "description" => "Данные не заполнены"
            ]);
        }
    }

// Общая функция валидации параметра
    private function validate ($field, $validation) {
        $validateParams = $validation->values();
        $state = (bool) 1;
        if ($validateParams->len_regex() !== "") {
            $field_true_len = strlen(preg_replace($validateParams->len_regex(),'', $field));
        } else {
            $field_true_len = strlen($field);
        }
        foreach ($validateParams->toArray() as $key => $value) {
            if ($value !== "") {
                switch ($key) {
                    case "regex";
                        $state = $field_true_len > 0 && preg_match('/'.$value.'/', $field);
                        break;
                    case "required";
                        $state = $field_true_len > 0;
                        break;
                    case "min_length";
                        $state = $field_true_len >= intval($value);
                        break;
                    case "max_length";
                        $state = $field_true_len <= intval($value);
                        break;
                    default:
                    break;
                }
                if (!$state) {
                    return $state;
                }
            }
        }
        return $state;
    }

// Поиск заданного телефонного кода
    private function getCountryByPhoneCode ($code) {
        $result = array_search(preg_replace("~\D+~", '', $code), $this->codesArr());
        if (is_bool($result)) {
            return "";
        } else {
            return array_search($result, $this->countriesArr());
        }
    }

// Данные о кодах, по хорошему доставать из базы
    private function codesArr () {
        return array(                        "AD" => "376",
                                             "AE" => "971",
                                             "AF" => "93",
                                             "AG" => "1-268",
                                             "AI" => "1-264",
                                             "AL" => "355",
                                             "AM" => "374",
                                             "AO" => "244",
                                             "AR" => "54",
                                             "AS" => "1-684",
                                             "AT" => "43",
                                             "AU" => "61",
                                             "AW" => "297",
                                             "AX" => "358-18",
                                             "AZ" => "994",
                                             "BA" => "387",
                                             "BB" => "1-246",
                                             "BD" => "880",
                                             "BE" => "32",
                                             "BF" => "226",
                                             "BG" => "359",
                                             "BH" => "973",
                                             "BI" => "257",
                                             "BJ" => "229",
                                             "BL" => "590",
                                             "BM" => "1-441",
                                             "BN" => "673",
                                             "BO" => "591",
                                             "BQ" => "599",
                                             "BR" => "55",
                                             "BS" => "1-242",
                                             "BT" => "975",
                                             "BW" => "267",
                                             "BY" => "375",
                                             "BZ" => "501",
                                             "CA" => "1",
                                             "CC" => "61",
                                             "CD" => "243",
                                             "CF" => "236",
                                             "CG" => "242",
                                             "CH" => "41",
                                             "CI" => "225",
                                             "CK" => "682",
                                             "CL" => "56",
                                             "CM" => "237",
                                             "CN" => "86",
                                             "CO" => "57",
                                             "CR" => "506",
                                             "CU" => "53",
                                             "CV" => "238",
                                             "CW" => "599",
                                             "CX" => "61",
                                             "CY" => "357",
                                             "CZ" => "420",
                                             "DE" => "49",
                                             "DJ" => "253",
                                             "DK" => "45",
                                             "DM" => "1-767",
                                             "DO" => "1-809",
                                             "DO" => "1-829",
                                             "DZ" => "213",
                                             "EC" => "593",
                                             "EE" => "372",
                                             "EG" => "20",
                                             "EH" => "212",
                                             "ER" => "291",
                                             "ES" => "34",
                                             "ET" => "251",
                                             "FI" => "358",
                                             "FJ" => "679",
                                             "FK" => "500",
                                             "FM" => "691",
                                             "FO" => "298",
                                             "FR" => "33",
                                             "GA" => "241",
                                             "GB" => "44",
                                             "GD" => "1-473",
                                             "GE" => "995",
                                             "GF" => "594",
                                             "GG" => "44-1481",
                                             "GH" => "233",
                                             "GI" => "350",
                                             "GL" => "299",
                                             "GM" => "220",
                                             "GN" => "224",
                                             "GP" => "590",
                                             "GQ" => "240",
                                             "GR" => "30",
                                             "GT" => "502",
                                             "GU" => "1-671",
                                             "GW" => "245",
                                             "GY" => "592",
                                             "HK" => "852",
                                             "HN" => "504",
                                             "HR" => "385",
                                             "HT" => "509",
                                             "HU" => "36",
                                             "ID" => "62",
                                             "IE" => "353",
                                             "IL" => "972",
                                             "IM" => "44-1624",
                                             "IN" => "91",
                                             "IO" => "246",
                                             "IQ" => "964",
                                             "IR" => "98",
                                             "IS" => "354",
                                             "IT" => "39",
                                             "JE" => "44-1534",
                                             "JM" => "1-876",
                                             "JO" => "962",
                                             "JP" => "81",
                                             "KE" => "254",
                                             "KG" => "996",
                                             "KH" => "855",
                                             "KI" => "686",
                                             "KM" => "269",
                                             "KN" => "1-869",
                                             "KP" => "850",
                                             "KR" => "82",
                                             "KW" => "965",
                                             "KY" => "1-345",
                                             "KZ" => "7",
                                             "LA" => "856",
                                             "LB" => "961",
                                             "LC" => "1-758",
                                             "LI" => "423",
                                             "LK" => "94",
                                             "LR" => "231",
                                             "LS" => "266",
                                             "LT" => "370",
                                             "LU" => "352",
                                             "LV" => "371",
                                             "LY" => "218",
                                             "MA" => "212",
                                             "MC" => "377",
                                             "MD" => "373",
                                             "ME" => "382",
                                             "MF" => "590",
                                             "MG" => "261",
                                             "MH" => "692",
                                             "MK" => "389",
                                             "ML" => "223",
                                             "MM" => "95",
                                             "MN" => "976",
                                             "MO" => "853",
                                             "MP" => "1-670",
                                             "MQ" => "596",
                                             "MR" => "222",
                                             "MS" => "1-664",
                                             "MT" => "356",
                                             "MU" => "230",
                                             "MV" => "960",
                                             "MW" => "265",
                                             "MX" => "52",
                                             "MY" => "60",
                                             "MZ" => "258",
                                             "NA" => "264",
                                             "NC" => "687",
                                             "NE" => "227",
                                             "NF" => "672",
                                             "NG" => "234",
                                             "NI" => "505",
                                             "NL" => "31",
                                             "NO" => "47",
                                             "NP" => "977",
                                             "NR" => "674",
                                             "NU" => "683",
                                             "NZ" => "64",
                                             "OM" => "968",
                                             "PA" => "507",
                                             "PE" => "51",
                                             "PF" => "689",
                                             "PG" => "675",
                                             "PH" => "63",
                                             "PK" => "92",
                                             "PL" => "48",
                                             "PM" => "508",
                                             "PN" => "870",
                                             "PR" => "1-787",
                                             "PR" => "1-939",
                                             "PS" => "970",
                                             "PT" => "351",
                                             "PW" => "680",
                                             "PY" => "595",
                                             "QA" => "974",
                                             "RE" => "262",
                                             "RO" => "40",
                                             "RS" => "381",
                                             "RU" => "7",
                                             "RW" => "250",
                                             "SA" => "966",
                                             "SB" => "677",
                                             "SC" => "248",
                                             "SD" => "249",
                                             "SE" => "46",
                                             "SG" => "65",
                                             "SH" => "290",
                                             "SI" => "386",
                                             "SJ" => "47",
                                             "SK" => "421",
                                             "SL" => "232",
                                             "SM" => "378",
                                             "SN" => "221",
                                             "SO" => "252",
                                             "SR" => "597",
                                             "SS" => "211",
                                             "ST" => "239",
                                             "SV" => "503",
                                             "SX" => "599",
                                             "SY" => "963",
                                             "SZ" => "268",
                                             "TC" => "1-649",
                                             "TD" => "235",
                                             "TG" => "228",
                                             "TH" => "66",
                                             "TJ" => "992",
                                             "TK" => "690",
                                             "TL" => "670",
                                             "TM" => "993",
                                             "TN" => "216",
                                             "TO" => "676",
                                             "TR" => "90",
                                             "TT" => "1-868",
                                             "TV" => "688",
                                             "TW" => "886",
                                             "TZ" => "255",
                                             "UA" => "380",
                                             "UG" => "256",
                                             "UM" => "1",
                                             "US" => "1",
                                             "UY" => "598",
                                             "UZ" => "998",
                                             "VA" => "379",
                                             "VC" => "1-784",
                                             "VE" => "58",
                                             "VG" => "1-284",
                                             "VI" => "1-340",
                                             "VN" => "84",
                                             "VU" => "678",
                                             "WF" => "681",
                                             "WS" => "685",
                                             "YE" => "967",
                                             "YT" => "262",
                                             "ZA" => "27",
                                             "ZM" => "260",
                                             "ZW" => "263"
                                         );
    }


    private function countriesArr () {
    return array (
"Абхазия" =>	"AB",
"Австралия" =>	"AU",
"Австрия" =>	"AT",
"Азербайджан" =>	"AZ",
"Албания" =>	"AL",
"Алжир" =>	"DZ",
"Американское Самоа" =>	"AS",
"Ангилья" =>	"AI",
"Ангола" =>	"AO",
"Андорра" =>	"AD",
"Антарктида" =>	"AQ",
"Антигуа и Барбуда" =>	"AG",
"Аргентина" =>	"AR",
"Армения" =>	"AM",
"Аруба" =>	"AW",
"Афганистан" =>	"AF",
"Багамы" =>	"BS",
"Бангладеш" =>	"BD",
"Барбадос" =>	"BB",
"Бахрейн" =>	"BH",
"Беларусь" =>	"BY",
"Белиз" =>	"BZ",
"Бельгия" =>	"BE",
"Бенин" =>	"BJ",
"Бермуды" =>	"BM",
"Болгария" =>	"BG",
"Боливия, Многонациональное Государство" =>	"BO",
"Бонайре, Саба и Синт-Эстатиус" =>	"BQ",
"Босния и Герцеговина" =>	"BA",
"Ботсвана" =>	"BW",
"Бразилия" =>	"BR",
"Британская территория в Индийском океане" =>	"IO",
"Бруней-Даруссалам" =>	"BN",
"Буркина-Фасо" =>	"BF",
"Бурунди" =>	"BI",
"Бутан" =>	"BT",
"Вануату" =>	"VU",
"Венгрия" =>	"HU",
"Венесуэла Боливарианская Республика" =>	"VE",
"Виргинские острова, Британские" =>	"VG",
"Виргинские острова, США" =>	"VI",
"Вьетнам" =>	"VN",
"Габон" =>	"GA",
"Гаити" =>	"HT",
"Гайана" =>	"GY",
"Гамбия" =>	"GM",
"Гана" =>	"GH",
"Гваделупа" =>	"GP",
"Гватемала" =>	"GT",
"Гвинея" =>	"GN",
"Гвинея-Бисау" =>	"GW",
"Германия" =>	"DE",
"Гернси" =>	"GG",
"Гибралтар" =>	"GI",
"Гондурас" =>	"HN",
"Гонконг" =>	"HK",
"Гренада" =>	"GD",
"Гренландия" =>	"GL",
"Греция" =>	"GR",
"Грузия" =>	"GE",
"Гуам" =>	"GU",
"Дания" =>	"DK",
"Джерси" =>	"JE",
"Джибути" =>	"DJ",
"Доминика" =>	"DM",
"Доминиканская Республика" =>	"DO",
"Египет" =>	"EG",
"Замбия" =>	"ZM",
"Западная Сахара" =>	"EH",
"Зимбабве" =>	"ZW",
"Израиль" =>	"IL",
"Индия" =>	"IN",
"Индонезия" =>	"ID",
"Иордания" =>	"JO",
"Ирак" =>	"IQ",
"Иран, Исламская Республика" =>	"IR",
"Ирландия" =>	"IE",
"Исландия" =>	"IS",
"Испания" =>	"ES",
"Италия" =>	"IT",
"Йемен" =>	"YE",
"Кабо-Верде" =>	"CV",
"Казахстан" =>	"KZ",
"Камбоджа" =>	"KH",
"Камерун" =>	"CM",
"Канада" =>	"CA",
"Катар" =>	"QA",
"Кения" =>	"KE",
"Кипр" =>	"CY",
"Киргизия" =>	"KG",
"Кирибати" =>	"KI",
"Китай" =>	"CN",
"Кокосовые (Килинг) острова" =>	"CC",
"Колумбия" =>	"CO",
"Коморы" =>	"KM",
"Конго" =>	"CG",
"Конго, Демократическая Республика" =>	"CD",
"Корея, Народно-Демократическая Республика" =>	"KP",
"Корея, Республика" =>	"KR",
"Коста-Рика" =>	"CR",
"Кот д'Ивуар" =>	"CI",
"Куба" =>	"CU",
"Кувейт" =>	"KW",
"Кюрасао" =>	"CW",
"Лаос" =>	"LA",
"Латвия" =>	"LV",
"Лесото" =>	"LS",
"Ливан" =>	"LB",
"Ливийская Арабская Джамахирия" =>	"LY",
"Либерия" =>	"LR",
"Лихтенштейн" =>	"LI",
"Литва" =>	"LT",
"Люксембург" =>	"LU",
"Маврикий" =>	"MU",
"Мавритания" =>	"MR",
"Мадагаскар" =>	"MG",
"Майотта" =>	"YT",
"Макао" =>	"MO",
"Малави" =>	"MW",
"Малайзия" =>	"MY",
"Мали" =>	"ML",
"Малые Тихоокеанские отдаленные острова Соединенных Штатов" =>	"UM",
"Мальдивы" =>	"MV",
"Мальта" =>	"MT",
"Марокко" =>	"MA",
"Мартиника" =>	"MQ",
"Маршалловы острова" =>	"MH",
"Мексика" =>	"MX",
"Микронезия, Федеративные Штаты" =>	"FM",
"Мозамбик" =>	"MZ",
"Молдова, Республика" =>	"MD",
"Монако" =>	"MC",
"Монголия" =>	"MN",
"Монтсеррат" =>	"MS",
"Мьянма" =>	"MM",
"Намибия" =>	"NA",
"Науру" =>	"NR",
"Непал" =>	"NP",
"Нигер" =>	"NE",
"Нигерия" =>	"NG",
"Нидерланды" =>	"NL",
"Никарагуа" =>	"NI",
"Ниуэ" =>	"NU",
"Новая Зеландия" =>	"NZ",
"Новая Каледония" =>	"NC",
"Норвегия" =>	"NO",
"Объединенные Арабские Эмираты" =>	"AE",
"Оман" =>	"OM",
"Остров Буве" =>	"BV",
"Остров Мэн" =>	"IM",
"Остров Норфолк" =>	"NF",
"Остров Рождества" =>	"CX",
"Остров Херд и острова Макдональд" =>	"HM",
"Острова Кайман" =>	"KY",
"Острова Кука" =>	"CK",
"Острова Теркс и Кайкос" =>	"TC",
"Пакистан" =>	"PK",
"Палау" =>	"PW",
"Палестинская территория, оккупированная" =>	"PS",
"Панама" =>	"PA",
"Папский Престол (Государство — город Ватикан)" =>	"VA",
"Папуа-Новая Гвинея" =>	"PG",
"Парагвай" =>	"PY",
"Перу" =>	"PE",
"Питкерн" =>	"PN",
"Польша" =>	"PL",
"Португалия" =>	"PT",
"Пуэрто-Рико" =>	"PR",
"Республика Македония" =>	"MK",
"Реюньон" =>	"RE",
"Россия" =>	"RU",
"Руанда" =>	"RW",
"Румыния" =>	"RO",
"Самоа" =>	"WS",
"Сан-Марино" =>	"SM",
"Сан-Томе и Принсипи" =>	"ST",
"Саудовская Аравия" =>	"SA",
"Святая Елена, Остров вознесения, Тристан-да-Кунья" =>	"SH",
"Северные Марианские острова" =>	"MP",
"Сен-Бартельми" =>	"BL",
"Сен-Мартен" =>	"MF",
"Сенегал" =>	"SN",
"Сент-Винсент и Гренадины" =>	"VC",
"Сент-Китс и Невис" =>	"KN",
"Сент-Люсия" =>	"LC",
"Сент-Пьер и Микелон" =>	"PM",
"Сербия" =>	"RS",
"Сейшелы" =>	"SC",
"Сингапур" =>	"SG",
"Синт-Мартен" =>	"SX",
"Сирийская Арабская Республика" =>	"SY",
"Словакия" =>	"SK",
"Словения" =>	"SI",
"Соединенное Королевство" =>	"GB",
"Соединенные Штаты" =>	"US",
"Соломоновы острова" =>	"SB",
"Сомали" =>	"SO",
"Судан" =>	"SD",
"Суринам" =>	"SR",
"Сьерра-Леоне" =>	"SL",
"Таджикистан" =>	"TJ",
"Таиланд" =>	"TH",
"Тайвань (Китай)" =>	"TW",
"Танзания, Объединенная Республика" =>	"TZ",
"Тимор-Лесте" =>	"TL",
"Того" =>	"TG",
"Токелау" =>	"TK",
"Тонга" =>	"TO",
"Тринидад и Тобаго" =>	"TT",
"Тувалу" =>	"TV",
"Тунис" =>	"TN",
"Туркмения" =>	"TM",
"Турция" =>	"TR",
"Уганда" =>	"UG",
"Узбекистан" =>	"UZ",
"Украина" =>	"UA",
"Уоллис и Футуна" =>	"WF",
"Уругвай" =>	"UY",
"Фарерские острова" =>	"FO",
"Фиджи" =>	"FJ",
"Филиппины" =>	"PH",
"Финляндия" =>	"FI",
"Фолклендские острова (Мальвинские)" =>	"FK",
"Франция" =>	"FR",
"Французская Гвиана" =>	"GF",
"Французская Полинезия" =>	"PF",
"Французские Южные территории" =>	"TF",
"Хорватия" =>	"HR",
"Центрально-Африканская Республика" =>	"CF",
"Чад" =>	"TD",
"Черногория" =>	"ME",
"Чешская Республика" =>	"CZ",
"Чили" =>	"CL",
"Швейцария" =>	"CH",
"Швеция" =>	"SE",
"Шпицберген и Ян Майен" =>	"SJ",
"Шри-Ланка" =>	"LK",
"Эквадор" =>	"EC",
"Экваториальная Гвинея" =>	"GQ",
"Эландские острова" =>	"AX",
"Эль-Сальвадор" =>	"SV",
"Эритрея" =>	"ER",
"Эсватини" =>	"SZ",
"Эстония" =>	"EE",
"Эфиопия" =>	"ET",
"Южная Африка" =>	"ZA",
"Южная Джорджия и Южные Сандвичевы острова" =>	"GS",
"Южная Осетия" =>	"OS",
"Южный Судан" =>	"SS",
"Ямайка" =>	"JM",
"Япония" =>	"JP"
    );
  }
}
